<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Certificate</title>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
    <div class="header1">
        <h1>Generate Certificates</h1>
    </div>
    <h3>Upload an Excel File</h3>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload</button>
    <div id="coordinatesDisplay"></div>
    <h4>Mark Coordinates</h4>
    <input type="file" id="imageFileInput">
    <button onclick="uploadImage()">Upload Image</button>
    <canvas id="coordinateCanvas" width="800" height="600" onclick="markCoordinates(event)"></canvas>
    <br>
    <label for="nameColumn">Name a Column:</label>
    <input type="text" id="nameColumn">
    <br>
    <label for="xCoord">X Coordinate:</label>
    <input type="number" id="xCoord">
    <br>
    <label for="yCoord">Y Coordinate:</label>
    <input type="number" id="yCoord">
    <br>
    <label for="fontSize">Font Size:</label>
    <input type="number" id="fontSize" value="16">
    <br>
    <label for="fontFamily">Font Family:</label>
    <select id="fontFamily">
        <option value="Arial">Arial</option>
        <option value="Verdana">Verdana</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Georgia">Georgia</option>
        <option value="Courier New">Courier New</option>
    </select>
    <br>
    <h3>Generate Certificate</h3>
    <button onclick="generateCertificate()">Generate Certificate</button>
    <button onclick="downloadCertificates()">Download Certificates</button>
    <div id="coordinatesDisplay"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        let namesData = []; // Initialize namesData array
        let certificatesData = []; // Initialize certificatesData array

        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming the data is in the first sheet and the names are in column A (index 0)
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                namesData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

                // Store the extracted data in localStorage
                localStorage.setItem('namesData', JSON.stringify(namesData));

                alert('File uploaded successfully.');
            };
            reader.readAsArrayBuffer(file);
        }

        const previewArea = document.getElementById('previewArea');
        let templateImage; // Define uploadedImage variable

        function markCoordinates(event) {
            const x = event.offsetX;
            const y = event.offsetY;

            document.getElementById('xCoord').value = x;
            document.getElementById('yCoord').value = y;
        }

        function uploadImage() {
            const imageFileInput = document.getElementById('imageFileInput');
            templateImage = imageFileInput.files[0]; // Assign the uploaded image to templateImage variable

            if (!templateImage) {
                alert('Please select an image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const image = new Image();
                image.onload = function () {
                    const coordCanvas = document.getElementById('coordinateCanvas');
                    const coordCtx = coordCanvas.getContext('2d');
                    coordCtx.clearRect(0, 0, coordCanvas.width, coordCanvas.height);
                    coordCtx.drawImage(image, 0, 0, coordCanvas.width, coordCanvas.height);
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(templateImage);
        }

        async function generateCertificate() {
            const nameColumn = document.getElementById('nameColumn').value;
            const xCoord = parseInt(document.getElementById('xCoord').value);
            const yCoord = parseInt(document.getElementById('yCoord').value);
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const fontFamily = document.getElementById('fontFamily').value;

            if (!nameColumn || isNaN(xCoord) || isNaN(yCoord) || isNaN(fontSize)) {
                alert('Please enter valid input values.');
                return;
            }

            certificatesData = []; // Clear previous certificates data

            const names = namesData.slice(1).map(row => row[0]);

            const image = new Image();
            image.onload = async function () {
                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                ctx.font = `${fontSize}px ${fontFamily}`;
                ctx.fillStyle = 'black';
                names.forEach((name, index) => {
                    const templateCanvas = document.createElement('canvas');
                    templateCanvas.width = canvas.width;
                    templateCanvas.height = canvas.height;
                    const templateCtx = templateCanvas.getContext('2d');
                    templateCtx.drawImage(image, 0, 0, templateCanvas.width, templateCanvas.height);
                    templateCtx.font = `${fontSize}px ${fontFamily}`;
                    templateCtx.fillStyle = 'black';
                    templateCtx.fillText(name, xCoord, yCoord); // Fixed coordinates for each name
                    const imageData = templateCanvas.toDataURL('image/jpeg', 1);
                    certificatesData.push({ name, imageData }); // Store certificate data
                });
                alert('Certificates generated successfully.');
            };

            // Use the uploaded image as the template image
            image.src = URL.createObjectURL(templateImage);
        }

        function downloadCertificates() {
            if (certificatesData.length === 0) {
                alert('No certificates generated yet.');
                return;
            }

            const zip = new JSZip();
            const folder = zip.folder('Certificates');

            certificatesData.forEach(({ name, imageData }, index) => {
                const filename = `${name}_${index + 1}.jpg`;
                folder.file(filename, imageData.split('base64,')[1], { base64: true });
            });

            zip.generateAsync({ type: 'blob' })
                .then(function (content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'Certificates.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        }
    </script>
    <hr class="partition-line">
    <div class="options">
        <button onclick="location.href='index.html'">Home</button>
        <button onclick="location.href='edit_template.html'">Edit Template</button>
        <button onclick="location.href='generate_certificate.html'">Generate Certificate</button>
        <button onclick="location.href='feedback.html'">FeedBack</button>
    </div>
</body>
</html>
